# IoT Gateway 项目大纲

## 项目概述
IoT Gateway 是基于 .NET 6.0 框架开发的跨平台工业物联网网关系统，采用 B/S 架构，提供可视化配置界面。该系统支持南向连接到各种设备和系统（如 PLC、扫码枪、CNC、数据库、串口设备、上位机、非标设备、OPC Server、OPC UA Server、Mqtt Server 等），同时北向连接到 IoTSharp、ThingsCloud、ThingsBoard、华为云或自定义物联网平台（MES、SCADA 等），实现双向数据通讯和边缘计算功能。

## 项目结构

### 1. IoTGateway（核心模块）
核心模块提供基础的设备管理、通信管理、数据上报、规则管理等功能。

#### 1.1 Program.cs & Startup.cs
- **功能**：应用程序入口点和配置
- **原理**：负责初始化应用程序、配置服务、设置中间件管道

#### 1.2 Areas（功能区域划分）
##### 1.2.1 BasicData（基础数据管理）
- **功能**：提供设备、驱动、变量的管理界面
- **子模块**：
  - **Device（设备管理）**：添加、编辑、删除和监控设备
  - **DeviceConfig（设备连接参数管理）**：设置和调整设备连接参数
  - **DeviceVariable（设备采集变量管理）**：定义和配置设备采集的数据点
  - **Driver（驱动管理）**：驱动的上传、下载和管理

##### 1.2.2 Config（系统配置）
- **功能**：系统级配置管理
- **原理**：提供系统参数设置和调整的界面

##### 1.2.3 MqttServer（MQTT服务器管理）
- **功能**：内置 MQTT 服务器的管理
- **原理**：提供 MQTT 服务（端口 1888）支持 WebSocket-MQTT，可直连 MES、SCADA 等系统

##### 1.2.4 Rpc（远程过程调用）
- **功能**：RPC 接口管理
- **原理**：支持远程调用设备功能，实现反向控制

##### 1.2.5 _Admin（系统管理）
- **功能**：用户、角色、权限等系统管理功能
- **原理**：基于 WalkingTec.Mvvm 框架实现权限管理

#### 1.3 Controllers（控制器）
- **功能**：API 控制器
- **原理**：处理前端请求，调用相应的服务

#### 1.4 Views（视图）
- **功能**：Web 界面模板
- **原理**：定义用户界面的结构和布局

#### 1.5 wwwroot（静态资源）
- **功能**：包含 JS、CSS、图片等静态资源
- **原理**：为前端界面提供所需的静态资源文件

### 2. IoTGateway.DataAccess（数据访问层）
- **功能**：数据库访问和操作
- **原理**：提供数据持久化服务，管理系统配置、设备信息、变量数据等

### 3. IoTGateway.Model（数据模型层）
- **功能**：定义系统数据模型
- **原理**：包含设备、变量、驱动等实体类定义

### 4. IoTGateway.ViewModel（视图模型层）
- **功能**：定义视图模型
- **原理**：为前端界面提供数据绑定模型

### 5. Plugins（插件系统）

#### 5.1 PluginInterface（插件接口）
- **功能**：定义插件接口规范
- **原理**：提供统一的接口规范，包括：
  - **IDriver**：驱动接口定义
  - **数据类型定义**：如 DataTypeEnum, EndianEnum 等
  - **属性定义**：如 AddressDefinitionAttribute, ConfigParameterAttribute 等

#### 5.2 Drivers（驱动实现）
- **功能**：实现各种设备驱动
- **主要驱动类型**：
  - **PLC 类**：SiemensS7（西门子）、MelsecMc（三菱）、ModBusMaster、OmronFins（欧姆龙）、AllenBradley（AB）
  - **CNC 类**：Fanuc（发那科）、MTConnect
  - **OPC 类**：UaClient（OPC UA）、DaClient（OPC DA）
  - **通信类**：MQTT.Driver、HTTP.JsonClient、WebSocket.Client
  - **其他特定设备**：如 Toledo、DKScrew 等

#### 5.3 Plugin（插件管理）
- **功能**：加载、管理和调度驱动插件
- **原理**：提供驱动的动态加载和生命周期管理

### 6. 数据流向与工作原理

#### 6.1 南向数据采集流程
1. **设备配置**：在 BasicData/Device 中添加设备并选择适当的驱动
2. **连接参数配置**：在 BasicData/DeviceConfig 中配置设备连接参数
3. **变量定义**：在 BasicData/DeviceVariable 中定义需要采集的数据点
4. **数据采集**：驱动根据配置连接到设备并按照定义的变量采集数据
5. **数据解析**：将采集到的原始数据解析为标准格式
6. **数据存储与分发**：将数据存储到本地数据库并根据配置分发上报

#### 6.2 北向数据上报流程
1. **平台配置**：配置目标物联网平台连接参数
2. **数据映射**：将采集变量映射到平台定义的遥测或属性
3. **数据上报**：按照变化上传或定时归档策略上报数据
4. **RPC 调用**：接收并处理来自平台的 RPC 调用，执行设备控制

#### 6.3 边缘服务
1. **MQTT 服务**：内置 MQTT 服务器（端口 1888），支持其他系统直接订阅数据
2. **OPC UA 服务**：内置 OPC UA 服务器（opc.tcp://localhost:62541），允许 OPC UA 客户端连接
3. **ModbusSlave**：内置 Modbus 模拟设备服务（端口 503）

### 7. 扩展开发指南

#### 7.1 添加新驱动
1. 在 Plugins/Drivers 下创建新的驱动项目
2. 实现 IDriver 接口
3. 使用相关属性标记驱动信息和参数定义
4. 编译并将 DLL 文件放入系统的 Drivers 目录

#### 7.2 自定义数据处理
1. 利用计算表达式功能对数据进行边缘处理
2. 通过变量配置中的上传策略自定义数据上报逻辑

#### 7.3 系统集成
1. 通过内置服务（MQTT、OPC UA、Modbus）与其他系统集成
2. 利用 Web API 进行系统间的数据交换和控制

## 总结
IoT Gateway 是一个功能完善的工业物联网边缘网关系统，通过可插拔的驱动架构实现对多种设备的灵活连接，并提供多种北向集成选项。系统采用 B/S 架构，提供友好的可视化配置界面，支持边缘计算和数据处理，适用于各种工业场景的数据采集和设备管理需求。
